<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rewards - WaLoad</title>
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="profile-container">
    <div class="history-header fixed-top">
      <a href="../index.html" class="nav-btn" aria-label="Back to home"><i class="fa-solid fa-arrow-left"></i></a>
      <h1 class="page-title">Rewards</h1>
    </div>

    <div style="height:72px;"></div>

    <div class="profile-card rewards-container">
      <div class="strong">Your Rewards</div>
      <div class="small mb-8">Cashbacks, coupons and promos based on your activity.</div>

      <div style="margin-top:12px;">
        <div class="strong">Total Unclaimed Cashback</div>
        <div id="rewardsCashback" class="small">₦0.00</div>
        <div style="margin-top:8px;"><button id="claimCashback" class="btn">Claim Cashback</button></div>
      </div>

      <hr style="margin:16px 0;border:none;border-top:1px solid #eee;" />

      <div class="strong">Your Coupons</div>
      <div id="couponsList" class="card-list" style="margin-top:8px;"></div>

      <hr style="margin:16px 0;border:none;border-top:1px solid #eee;" />

      <div class="strong">Active Promotions</div>
      <div class="small" style="margin-top:8px;">- 1% cashback on purchases (Data, TV, Electricity).<br>- Spend ₦1,000+ to receive a coupon worth 2% of that transaction.</div>
    </div>

  </div>

  <nav class="bottom-nav" role="navigation" aria-label="Bottom Navigation">
    <a href="../index.html" class="nav-btn">
      <i class="fa-solid fa-house" aria-hidden="true"></i>
      <span>Home</span>
    </a>
    <a href="#" class="nav-btn">
      <i class="fa-solid fa-wallet" aria-hidden="true"></i>
      <span>Finance</span>
    </a>
    <a href="rewards.html" class="nav-btn active">
      <i class="fa-solid fa-gift" aria-hidden="true"></i>
      <span>Rewards</span>
    </a>
    <a href="profile.html" class="nav-btn">
      <i class="fa-solid fa-user" aria-hidden="true"></i>
      <span>Me</span>
    </a>
  </nav>

  <script src="../js/script.js"></script>
  <script>
    (function(){
      // Rewards page: compute cashback and coupons
      function qs(id){return document.getElementById(id);}
      var cashbackEl = qs('rewardsCashback');
      var claimBtn = qs('claimCashback');
      var couponsList = qs('couponsList');
      try{
        var txs = JSON.parse(localStorage.getItem('vtu_transactions')||'[]');
      }catch(e){var txs=[]}
      // compute unclaimed cashback: 1% of spending (exclude deposits/transfers)
      var cb = 0;
      txs.forEach(function(tx){ if(['recharge','data','electricity','tv'].indexOf(tx.type)!==-1){ cb += Number(tx.amount||0) * 0.01; }});
      cb = Math.round(cb*100)/100;
      if(cashbackEl) cashbackEl.textContent = '₦' + cb.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

      // coupons: scan transactions and create coupon objects in localStorage if not present
      var existing = JSON.parse(localStorage.getItem('vtu_coupons')||'[]');
      var coupons = existing.slice();
      txs.forEach(function(tx){ if(Number(tx.amount||0) >= 1000 && ['recharge','data','electricity','tv'].indexOf(tx.type)!==-1){ var found = coupons.find(function(c){return c.txId===tx.id}); if(!found){ var code = 'CPN-'+String(tx.id).slice(-6).toUpperCase(); var val = Math.round(Number(tx.amount||0) * 0.02); coupons.push({code:code,txId:tx.id,value:val,used:false}); } }});
      localStorage.setItem('vtu_coupons', JSON.stringify(coupons));
      // render coupons
      function renderCoupons(){ couponsList.innerHTML=''; if(!coupons.length){ couponsList.innerHTML='<div class="small">No coupons yet</div>'; return; } coupons.forEach(function(c,idx){ var div = document.createElement('div'); div.className='card-item'; div.innerHTML = '<div><div class="strong">'+c.code+'</div><div class="small">Value: ₦'+Number(c.value).toLocaleString()+'</div></div><div>'+(c.used?'<span class="small">Used</span>':'<button data-idx="'+idx+'" class="btn apply-coupon">Apply</button>')+'</div>'; couponsList.appendChild(div); }); Array.from(couponsList.querySelectorAll('.apply-coupon')).forEach(function(b){ b.addEventListener('click', function(){ var idx = Number(b.dataset.idx); var c = coupons[idx]; if(!c) return; // apply: add coupon value to balance as a reward transaction and mark used
          try{ var balEl = document.getElementById('balanceAmount'); var amt = Number(c.value); var key = 'vtu_transactions'; var list = JSON.parse(localStorage.getItem(key)||'[]'); list.unshift({id:Date.now(),type:'coupon',name:'Coupon '+c.code,amount:amt,date:new Date().toISOString()}); localStorage.setItem(key, JSON.stringify(list)); // mark used
            coupons[idx].used = true; localStorage.setItem('vtu_coupons', JSON.stringify(coupons)); alert('Coupon applied: ₦'+amt); window.location.reload(); }catch(e){ alert('Could not apply coupon'); } }); }); }
      renderCoupons();

      if(claimBtn){ claimBtn.addEventListener('click', function(){ if(cb<=0){ alert('No cashback available'); return; } // credit cashback as reward
          try{ var key='vtu_transactions'; var list=JSON.parse(localStorage.getItem(key)||'[]'); list.unshift({id:Date.now(),type:'reward',name:'Cashback Claim',amount:cb,date:new Date().toISOString()}); localStorage.setItem(key,JSON.stringify(list)); showToast && showToast('Cashback claimed: ₦'+cb,'success'); alert('Cashback claimed: ₦'+cb); window.location.reload(); }catch(e){ alert('Could not claim cashback'); } }); }
    })();
  </script>
</body>
</html>